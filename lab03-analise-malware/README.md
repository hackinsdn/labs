# Roteiro do Laboratório de análise de Malware.

![Topology](https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/images/topology.drawio.png)

## Atividade 1: Teste de Conectividade

Para verificar a conectividade, siga os passos abaixo:

1. Verifique se a topologia foi carregada corretamente no Mininet-SEC. Esse passo é essencial para acessar os hosts que fazem parte do laboratório.

   ![mininet_topologia](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet_topologia.png?raw=true)

   ![topologia](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/lab_malware.PNG?raw=true)



> [!IMPORTANT]
> Você pode acessar o terminal dos hosts clicando duas vezes sobre eles ou pressionando o botão esquerdo do mouse e selecionando a opção "Terminal".


2. Verifique se é possível acessar o terminal do Mininet-SEC.
    ![mininet](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet.png?raw=true)

4. Verifique se é possível acessar a interface do MSIP.
    ![misp](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/misp.png?raw=true)

## Atividade 2: Detecção de Malware:

A técnica de engenharia social explora falhas humanas, visando persuadir a vítima a efetuar ações que facilitem o acesso indevido a sistemas restritos. Por meio da manipulação emocional, os atacantes transmitem mensagens geralmente com caráter de urgência com a intenção de provocar emoções como, por exemplo, medo, empolgação, curiosidade, para assim convencê-la. Após conseguir a confiança da vítima, o atacante consegue efetuar o roubo de informações pessoais e dinheiro, realizar infecções por malware, ou qualquer outra ação que pode gerar prejuízos ao usuário. O phishing, golpes de baiting, ataques de pretexto e ataques de DNS spoofing são apenas alguns exemplos de ataques que utilizam a engenharia social como base. 

![fraude](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/fraud16510.jpg?raw=true)
*Fonte: Catálogo de Fraudes da RNP*

Na imagem acima, é apresentado um exemplo de phishing bastante comum que tem sido transmitido via email. A mensagem é referente a um falso mandado de intimação judicial, na vítima é persuadida a efetuar o download do documento para ter acesso a mais informações informações a respeito do mandado, no entanto, ao clicar no link disponibilizado na mensagem um arquivo malicioso é baixado no sistema da vítima e caso executado poderá roubar informações do usuário. Este foi um caso real relatado no site no Catálogo de Fraudes da RNP, o qual é um repositório de mensagens classificadas como fraudulentas, que pode ser utilizado como uma fonte de informação que auxilia a não propagação de fraudes disseminadas por email e fornecendo informações sobre como se proteger desse tipo de golpe.

> [!TIP]
> Qual seria uma boa ação a se tomar ao receber um email como o apresentado na acima?


> [!TIP]
> Um dos ataques que utilizam a técnica de engenharia social são ataques watering hole, explique como esse tipo de ataque ocorre:

### Atividade 2.1 - Download de Arquivos Maliciosos

Para este laboratório vamos simular uma infecção por malware ocasionada por um ataque de phishing similar ao que foi divulgado pelo Catálogo de Fraudes da RNP. Na mensagem fictícia abaixo, cujo assunto é Resgate de Brindes, o usuário é induzido a clicar em um link para resgatar brindes de um suposto sorteio realizado por uma empresa de varejo. 

```
Olá, Cliente!

Temos uma ótima notícia para você! Seu e-mail foi sorteado no nosso sorteio anual de fidelização. Todos os anos, a nossa empresa realiza essa ação para presentear clientes como você, que fazem parte da nossa jornada com tanto carinho e confiança.

É a nossa forma de agradecer pelo excelente relacionamento e por nos escolher!

Clique no link abaixo para resgatar os brindes especiais que preparamos para você:

[Clique aqui para resgatar!]

Atenção: O link ficará disponível apenas pelas próximas 24h, a partir deste momento. Não perca!

Atenciosamente,
Equipe de Gestão de Relacionamento
VarejoEmFoco Ltda

Este é um e-mail automático. Por favor, não responda.
```

Agora, imagine que essa mensagem chegou à sua caixa de entrada. A primeira ação que você deve tomar é verificar se o remetente realmente pertence à empresa mencionada. Com uma rápida pesquisa no Google, você conseguirá encontrar mais informações sobre a empresa.

No caso da mensagem que estamos analisando, foi utilizada uma empresa fictícia, o que já nos levanta suspeitas sobre a veracidade das informações contidas no e-mail. Note que o atacante utiliza o fator da urgência para tentar pressionar o usuário a clicar no link rapidamente, com a promessa de uma recompensa falsa.
Um usuário atento se perguntaria se, de fato, está lidando com uma empresa com a qual tem relacionamento. A mensagem afirma que você foi incluído no sorteio devido à sua fidelidade com a empresa, o que indica que não deveria se tratar de uma empresa desconhecida para você.
Caso ainda tenha dúvidas sobre a autenticidade da mensagem, uma boa prática é, antes de clicar no link, compartilhar a URL em serviços de identificação de URLs maliciosas, como o CaUMa e o VirusTotal, por exemplo. Esses serviços mantêm uma base de dados de URLs maliciosas, coletadas pelo sistema ou reportadas por usuários, com o objetivo de identificar links suspeitos ou perigosos.

Vamos supor que você é um usuário desatento e não seguiu as recomendações feitas anteriormente e clicou no link contido na mensagem. Após clicar, um arquivo será instalado na sua máquina. Este arquivo se trata de um ransomware. O primeiro passo é fazer o download dos scripts e arquivos necessários para simular o ataque. Disponibilizamos um arquivo que será criptografado e scripts para efetuar a criptografia e descriptografia desse arquivo:

Acesse o terminal do Mininet-Sec a partir do Dashboard HackInSDN para efetuar o download dos arquivos:
![mininet](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet.png?raw=true)

Em seguida, no terminal do Mininet-Sec, execute os seguintes comandos:

```
cd /tmp

```
```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/ransomware/encrypter.py 
```
![f1](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f1.PNG?raw=true)
```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/ransomware/decrypter.py
```

![f2](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f2.PNG?raw=true)
```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/ransomware/hackinsdn.txt
```
![f3](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f3.PNG?raw=true)

## Atividade 3 - Análise de Malware

### Atividade 3.1 - Análise Estática

No processo da análise estática examinamos o malware sem executá-lo com o intuito de identificar informações no código que possam sinalizar possíveis ações maliciosas contidas no programa. Algumas ferramentas comuns de uso nesse processo de análise de binários são: IDA Pro, Ghidra e Radare2, por exemplo. 

Para este laboratório vamos usar duas ferramentas para exemplificar o processo de análise estática de malware. entender. URLhaus e YARA são ferramentas que nos ajudam a classificar e detectar malwares. 

**3.1.1 - Análise Comportamento Malicioso**
No terminal do Mininet-Sec execute o seguinte comando para conseguir visualizar o código:
```
cat /tmp/encrypter.py
```

Analise o código abaixo para identificar possíveis ações maliciosos:
![f4](https://github.com/hackinsdnlabs/blob/main/lab03-analise-malware/images/f4.PNG?raw=true)

Observe que esse código utiliza a biblioteca pyaes, a qual implementa o algoritmo AES (Advanced Encryption Standard) muito usado no processo de criptografia simétrica. É possível verificar também que na linha é criando um objeto AES que recebe a chave e em seguida é utilizada a função encrypt() para fazer a criptografia de um arquivo de texto presente na máquina do usuário (hackinsdn.txt). Em um ataque real, o cibercriminoso usaria essa função para criptografar todos os arquivos que considera relevantes para a vítima. Para isso, ele colocaria essa linha de código dentro de um laço de repetição (loop), permitindo a exploração dos diretórios da máquina comprometida. 


> [!TIP]
>  Qual é o principal objetivo de um ataque de phishing?


**Atividade 3.1.2 - Detecção e Classificação de Arquivos Maliciosos com o YARA**

Primeiro vamos coletar algumas informações de urls maliciosas por meio da API do URLhaus, para isso execute os comandos abaixo:

Esse faz uma requisição HTTP GET para a API do URLhaus, solicitando as 10 URLs maliciosas mais recentes cadastradas no banco de dados deles. Você pode determinar a quantidade de urls que serão coletadas alterando a parte limit/10/ do comando, se você preferir as 100 URLs mais recentes, por exemplo, você deverá usar limit/100/. 

```
cd /tmp
````

```
curl https://urlhaus-api.abuse.ch/v1/urls/recent/limit/10/

```
![f5](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f5.PNG?raw=true)

Este comando faz o download das URLs maliciosas mais recentes da API do URLhaus e salva a resposta em um arquivo JSON chamado urls_maliciosas_recente.json.
```
curl 'https://urlhaus-api.abuse.ch/v1/urls/recent/' -o  urls_maliciosas_recente.json
```
![f6](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f6.PNG?raw=true)

Na imagem abaixo é possível verificar como as informações da url são estruturas no arquivo gerado.

> [!NOTE]
>  Depois de coletar URLs maliciosas do URLhaus você pode gerar o hash desse arquivo. Com esse hash você pode enviar para o VirusTotal, o qual irá verificar se o arquivo é identificado como malicioso por diversos antivírus e outras ferramentas de segurança. Assim, você consegue validar rapidamente se o arquivo é uma ameaça real.

Podemos usar o YARA para criar uma regra de detecção para as URLs contidas nesse arquivo. Abaixo é possível verificar como construir essa regra:

```
rule DetectarMalware {
meta:
descripition = "Detecta host usado para malware_download"
strings:
$host1 = "182.34.*.*"
$host2 = "117.220.*.*"
$host3 = "42.55.*.*"
$host4 = "154.81.*.*"
$threat = "malware_download"
condition:
any of ($host*) or  $threat
}
```

Para executar a regra YARA você pode usar os comandos abaixo:
```
vi teste_Regra.yar
```
Copie e cole o exemplo de regra Yara apresentado acima no arquivo "teste_Regra.yar", depois digite :wq e pressione Enter para salvar e sair.

![f22](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f22.PNG?raw=true)


```
yara teste_Regra.yar urls_maliciosas_recente.json
````

Ao executarmos essa regra será possível detectar sempre que algum dos hosts listados for encontrado ou for detectada uma ameaça de malware na lista de URLs coletadas do URLhaus. Com o YARA é possível, por exemplo, criar regras para detectar se um binário pertence a uma família conhecida, escanear vários arquivos em busca de encontrar ameaças com base em regras definidas, fazer a detecção de malware em tempo real por meio da sua integração com antivírus, SIEMs ou sistemas de monitoramento, etc. 

> [!NOTE]
> O YARA, uma ferramenta de código aberto desenvolvida pela VirusTotal e permite que você utilize o VirusTotal Intelligence (VT Enterprise) para enviar suas regras YARA, que são aplicadas à extensa base de dados de arquivos do VirusTotal, notificando-o automaticamente sempre que novos arquivos corresponderem a essas regras.

**Atividade 3.1.3 - Correlacionamento de Ameaças**

O correlacionamento de ameaças é um processo no qual é possível conectar e analisar diferentes indicadores de compromisso (IoCs), comportamentos e padrões de ataque para identificar, entender e responder a ameaças cibernéticas de forma mais eficaz. O MISP é uma plataforma amplamente utilizada para o compartilhamento, a ferramenta possui uma API REST que viabiliza a importação e exportação de IoCs de forma automatizada.

Para acessar a API do MISP, vamos usar a biblioteca PyMISP. Ao executar os comandos abaixo você irá fazer o download do script de de importação de dados, os quais foram desenvolvidos na linguagem python:

```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/scriptsMISP/imporpyt_hash.
```
Agora vamos acessar a interface do MISP para selecionar o serviço do MISP. Ao clicar, você irá visualizar um alerta, basta clicar em "Avançadas" e em seguida em "Ir para site não seguro". 

![misp](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/misp.png?raw=true)


![f28](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f28.PNG?raw=true)

Aguarde alguns segundo o carregamento do serviço:

![f41](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f41.PNG?raw=true)

Para fazer o login forneça as seguintes credenciais de acesso:
```
E-mail: admin@localhost
```
```
Senha: hackinsdn
```

![f30](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f30.PNG?raw=true)

Na aba de menu do MISP clique na opção “Home” e em seguida em “List Events” como mostra as imagens abaixo:

![f31](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f31.PNG?raw=true)


Note que a lista de eventos está vazia, isso acontece porque não estamos usando uma instância de produção, a instância foi elaborado para os laboratórios do da plataforma HackInSDN e simula uma instância recém instalada, logo, por padrão, ao instalar o MISP ele não inicia com eventos pré-carregados. Dessa forma, será necessário criar novos eventos, efetuar a sincronização com outras instâncias e/ou habilitar as fontes automáticas de dados de inteligência de ameaça (feeds) disponíveis no MISP, inicialmente, vamos seguir com a última opção: habilitar os feeds públicos.

Para habilitar os feeds públicos você deve clicar em “Sync Actions” >> “Feeds”, serão listados os dois feeds públicos disponíveis no MISP: CIRCL OSINT Feed e The Botvrij eu Data. Para habilitar o feed selecione ele e clique em “Enable Selected” e em seguida em "Yes". As imagens abaixo ilustram o passo a passo que você deverá executar:

![f36](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f36.PNG?raw=true)

![f37](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f37.PNG?raw=true)

![f38](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f38.PNG?raw=true)

![f39](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f39.PNG?raw=true)

![f40](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f40.PNG?raw=true)


> [!IMPORTANT]
> O processo de carregamento dos eventos poderá demorar algumas horas, mas para vizualizar os novos eventos clique em “Event Actions > List Events” e deverá aparecer a lista de envios importados na instância. 

Você também pode criar um novo evento no MISP, para isso clique em "Add Event", preencha as informações do evento e em seguida clique em "Submit". Você conseguirá visualizar o evento criado na lista de eventos. Anote o ID do evento criado para teste, pois ele será usado nas etapas seguintes. As imagens abaixo ilustram o passo a passo que você deverá executar:

![f32](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f32.PNG?raw=true)


![f32](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f32.PNG?raw=true)

![f33](https://github.com/user-attachments/assets/d1120ef3-8188-4322-b19f-2df11bb9f488)

![f34](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f34.PNG?raw=true)

![f35](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f35.PNG?raw=true)


> [!IMPORTANT]
> Note que é gerado um aviso em o evento ter sido criado sem objetos/atributos, portanto o proximo passo será preencher esse evento com as urls coletadas do URLHAUS. 

Agora execute o script a partir do seguinte comando:

```
phyton3 -e <ID do evento criado> -i imporpyt_hash
```

O evento criado deverá aparecer no topo da lista de eventos, na interface do MISP clique novamente em “Event Actions > List Events” e procure o evento que foi criado. Ao clicar no evento será possivel as configurações do evento, a direita da tela veja a o HackInSDN, assim como os que foram compartilhados por outras organizações. A lista está configurada para exibir os eventos mais recentes no início, logo, no topo da lista você deverá visualizar o evento que acabou de criar, clicando no evento você terá acesso às informações do evento.

TODO

Note que no canto superior direito da tela aparece um painel chamado “Correlacionamento”, nesse painel são exibidos os eventos que apresentaram algum grau de compatibilidade em relação aos IoCs presentes na base de dados. Veja se os IDs dos eventos compatíveis são listados no painel.

Clique em “opção” para ter acesso ao mapa de compartilhamento:

TODO

Você também pode visualizar informações dos eventos apresentados no mapa:

TODO

Siga os passos abaixo para editar o evento:

TODO

### 3.2 - Análise Dinâmica
Na análise dinâmica é feita a execução do malware em um ambiente isolado, como o Mininet-Sec por exemplo, para ser possível verificar o seu comportamento em tempo real. Com isso, é possível realizar o monitoramento do sistema e da rede. 

**3.2.1 - Simulação de Ataque Ransomware**

Notícias como esta revelam que os ataques de ransomware estão crescendo e representam uma grande ameaça à segurança digital. Esse ataque consiste na execução de um malware que criptografa arquivos externos e bloqueia o acesso do usuário dono dos arquivos. Em seguida, o cibercriminoso solicita que a vítima transfira um valor para o resgate dos dados; geralmente, esse valor é pago em criptomoedas. Apesar de grandes empresas serem os alvos mais recorrentes desse tipo de ataque, usuários comuns também estão sujeitos a essa ameaça.

Utilizando o código anterior como exemplo, portanto, vamos executar o código encrypter.py para verificar na prática o comportamento de um ataque de ransomware, vamos imaginar que você é um usuário desatento e clicou no e-mail “Resgate de Brindes” apresentado no tópico 2.1. O download dos arquivos foi realizado na secção anterior, o próximo passo é executar o arquivo no host h101:

O Mininet-Sec é um emulador de redes responsável pela criação da topologia apresentada na Imagem 1. Clique no link do Serviço "http-mininet-sec" conforme ilustrado abaixo para abrir a interface web do Mininet-Sec:

![f8](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet_topologia.png?raw=true)


Neste exemplo, vamos simular um ataque de ransomware, execute o seguinte comando no Terminal do Mininet-Sec:

```
pip install pyaes
```
Essa biblioteca, a qual está sendo utilizada nos scripts encrypter.py e decrypter.py para criptografar e descriptografar os dados usando o algoritmo AES (Advanced Encryption Standard), que é um dos padrões mais utilizados de criptografia simétrica.

![f8](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f8.PNG?raw=true)

Agora, no terminal do outsider1 execute o seguinte comando:
```
python3 /tmp/encrypter.py
```

![f9](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f9.PNG?raw=true)

Veja que ao execuatr o comando fez com que o arquivo hackinsdn.txt fosse criptografado, substituindo-o por hackinsdn.txt.ransomware. Esse script acabou de simular o que acontece quando o usário executar um ransomware em sua máquina. Agora execute o comando abaixo para verificar o que aconteceu com o arquivo.

```
cat /tmp/hackinsdn.txt.ransomware

```
![f10](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f10.PNG?raw=true)

É possível notar que o arquivo hackinsdn.txt.ransomware contém caracteres incompreensíveis, pois o conteúdo foi criptografado utilizando criptografia simétrica. Para restaurar a legibilidade do arquivo, será necessário descriptografá-lo com o código decrypter.py. Em um ataque real, esse processo de descriptografia só poderia ser realizado pelo cibercriminoso, que exigiria um pagamento de resgate para liberar os dados para a vítima. Mas infelizmente, mesmo que efetuando o pagamento de resgate a vitima não tem garantia de que o cibercriminoso irá devolver o arquivo original. Para ter uma ideia de como funciona esse processo de descriptografia, ainda no terminal do outsider1, execute os comandos abaixo:

```
cat /tmp/ecrypter.py
```
![f23](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f23.PNG?raw=true)
```
python3 /tmp/decrypter.py
```

```
ls
```

```
cat /tmp/hackinsdn.txt
```
Como dito anteriormente, ao final o arquivo voltará ao seu formato original, conforme ilustrado na figura abaixo: 

![f12](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f12.PNG?raw=true)


> [!TIP]
>  O que caracteriza um ataque de ransomware?


> [!TIP]
>  Cite uma medida eficaz para prevenir ataques de ransomware:


**3.2.2 -  Simulação de Cryptojacking**

Seguindo na análise dinâmica vamos simular um ataque de criptografia maliciosa e em seguida vamos efetuar o monitoramento do sistema para verificar os impactos gerados. 

A criptografia maliciosa é um ataque que ocorre na execução não autorizada de um binário em um computador ou dispositivo móvel, com o intuito de utilizar seus recursos para minerar criptomoedas. O processo de mineração de criptomoedas requer bastante energia e recursos computacionais. Os cibercriminosos efetuaram esse tipo de ataque para não pagar por esses recursos, ou seja, para extrair a criptomoeda sem as grandes despesas.

Similar ao que fizemos na simulação do ataque de ransomware, vamos supor que, ao efetuar o download dos arquivos disponibilizados no link do e-mail “Resgate de Brindes”, você instalou um executável com o intuito de realizar a mineração de bitcoin.Vamos executar no h101 o arquivo bitcoinMining.py.

Acesse o terminal do h101 a partir do Dashboard HackInSDN para fazer o monitoramento do sistema, pois assim será possível comparar o estado anterior e posterior da execução do bitcoinMining.py. E, em seguida, no terminal do host h1, execute os seguintes comandos:

```
top
```
![f13](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f13.PNG?raw=true)

Observe que a CPU apresenta um consumo dentro dos limites esperados. 

<!--Este comando permite que você exiba em tempo real o consumo de CPU, memória, e outros recursos do sistema.

```
mpstat -P ALL 1
```

Este comando permite que você veja estatísticas detalhadas da CPU ao longo do tempo, com os parâmetros -P ALL 1 o uso da CPU será exibido a cada 1 segundo para todos os núcleos.

```
iotop
```

Este comando mostra a atividade de entrada/saída do disco em tempo real.

```
du -sh /tmp/
```

Este comando mostrará o tamanho total de todos os arquivos no diretório /tmp.

-->
Acesse o terminal do Mininet-Sec a partir do Dashboard HackInSDN para efetuar o download do arquivo:

![mininet](https://github.com/hackinsdnlabs/blob/main/lab03-analise-malware/images/mininet.png?raw=true)

Em seguida, no terminal do Mininet-Sec, execute os seguintes comandos:

```
cd /tmp
```
```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab_analyze_malware/maliciousEncryption/bitcoinMining.py
```
```
python /tmp/bitcoinMining.py
```
![f14](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f14.PNG?raw=true)

![f15](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f15.PNG?raw=true)


> [!TIP]
>  O que é cryptojacking?

### Atividade 3.3 - Monitoramento do Sistema

Na seção tópico anterior, simulamos um ataque de criptografia maliciosa. Agora, vamos utilizar as ferramentas de monitoramento da atividade anterior para analisar os impactos gerados pelo script bitcoinMining.py, ou seja, vamos comparar o estado do sistema antes e depois da execução do script.


Acesse o terminal do host h101 a partir do Dashboard HackInSDN para verificar se ocorrem alterações no consumo da CPU e do disco, para isso, execute os seguintes comandos:

```
top

```
![f17](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f17.PNG?raw=true)

Este comando permite que você exiba em tempo real o consumo de CPU, memória, e outros recursos do sistema. Observe que agora existe um processo que utiliza o comando python3 consumindo 100% da CPU, esse comportamento simula como um ataque de cryptojacking pode fazer uso não autorizado de recursos computacionais de um sistema para minerar criptomoedas. Geralmente, o processo roda em segundo plano, sem o consentimento do usuário, causando danos como: redução drasticamente o desempenho de outras aplicações críticas, aumento do consumo de energia e aquecimento excessivo, além de
danificar hardware em situações extremas e contínuas.

<!--
```
du -sh /tmp

```
![f19](https://github.com/user-attachments/assets/ba3a16af-1f9d-4c6f-8585-bac233d89ecb)

Este comando mostrará o tamanho total de todos os arquivos no diretório /tmp.
-->
```
dstat -c --cpu-adv

```
![f18.1](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f18.1.PNG?raw=true)

Este comando permite que você veja estatísticas detalhadas da CPU em tempo real, com o parâmetro -c você terá acesso estatísticas básicas de CPU e com o --cpu-adv você receberá informações avançadas da CPU.

Note que o top mostrou 100% de consumo da CPU, enquanto o dstat apresentou um uso moderado. Isso acontece porque, o top exibe o uso por processo individual, mostrando quanto de um núcleo aquele processo está consumindo. Já o dstat, mostra o uso agregado da CPU como um todo, somando o uso entre todos os núcleos. Essa divergência entre top e dstat é, portanto, esperada, visto que estamos apenas simulando um ataque. Em contextos reais de segurança, correlacionar múltiplas fontes de monitoramento (como top, dstat, mpstat, e logs de processo) é essencial para detectar comportamentos maliciosos disfarçados de processos legítimos. Dessa forma, podemos concluir que a mineração ilegal é caracterizada por um uso contínuo de 100% da CPU em um ou mais núcleos, apesar de a utilização total do sistema parecer "inferior". Esse padrão é um forte indicador de cryptojacking ou exploração de recursos sem autorização.


> [!TIP]
>  Qual sintoma no sistema pode indicar a presença de cryptojacking e como ele, geralmente, se propaga?

## Atividade 4 - Processo de Mitigação
O processo de mitigação envolve a implementação de ações e controles para reduzir ou neutralizar os impactos de uma ameaça cibernética identificada, minimizando os danos potenciais e evitando que a vulnerabilidade seja explorada novamente no futuro.

Neste laboratório vamos demonstrar algumas das principais etapas do processo de remediação de malware. Vamos simular o isolamento do arquivo, a verificação de hases, classificação do arquivo e, caso seja classificado como malicioso, a sua remoção segura.

<!--## 4.1 - Etapa de Quarentena

Quando identificamos um arquivo suspeito no sistema o ideal é movê-lo para a quarenta para que seja possível realizar análises futuras com segurança e preservação das evidências.  Execute os passos abaixo para mover os arquivos baixados anteriormente para a quarentena:

- Criação da pasta:

```
mkdir -p /var/quarentena
```

- Garanta que só o usuário root seja proprietário da pasta:
```
chown root:root /var/quarentena

```

- Aplique as permissões restritivas

```
chmod 700 /var/quarentena

```

- Após executar os comandos você terá essa saída:
```
drwx------ 2 root root 4096 abr 10 12:00 /var/quarentena

```

- Verifique se restrições foram aplicadas corretamente:
```
ls -ld /var/quarentena

```

- Após executar os comandos você terá essa saída:
```
drwx------ 2 root root 4096 abr 10 12:00 /var/quarentena
```

- Mova os arquivos baixados para a pasta criada, mas antes é interessante renomear o arquivo para evitar execução acidental:

```
mkdir -p /quarentena
chmod 700 /quarentena
mv /var/quarentena/bitcoinMining.py /var/quarentena/bitcoinMining.py.txt
```


- Garanta que arquivo seja imutável, ou seja, nem mesmo o root consegue editar ou deletar sem remover. Para isso, use o chattr para travar o arquivo:

```

chattr +i /var/quarentena/bitcoinMining.py

```
-->

## 4.1 Coletar o hash do arquivo

A coleta do hash de um arquivo é fundamental para identificar, verificar a integridade e cruzar informações sobre o arquivo em bancos de dados de ameaças, como o VirusTotal, sem a necessidade de executá-lo.

Para coletar o hash dos arquivos baixados nesse laboratório execute os comandos abaixo, no terminal do Mininet-Sec:

```
mkdir /tmp/zeek
```
```
cd /tmp/zeek
```
```
md5sum bitcoinMining.py >> md5.txt
sha256sum bitcoinMining.py >> sha256.txt
```

![f20](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f20.PNG?raw=true)

![f20](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f21.PNG?raw=true)


Agora vamos importar esses hashes para o evento que criamos anteriomente no MISP, para isso execute os passos abaixo:

```
cd /tmp/zeek
```

```
curl -LO https://raw.githubusercontent.com/Raquel-Santos/labs/refs/heads/main/lab03-analise-malware/scriptsMISP/import_hash.py
```

![f24](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f24.PNG?raw=true)


Agora no terminal do MISP execute o script:
```
cd /tmp/
```
```
python3 import_txt.py -e <ID do evento criando anteriormente> -i sha256.txt
```

> [!NOTE]
> Estamos usando o MD5 e SHA256, porque, apesar do MD5 não ser tão seguro ele é melhor para comparar com bancos de malware como o VirusTotal, já o SHA256 é mais seguro e por isso foi usado para garantir a integridade do arquivo:

## 4.2 Classificando com regra YARA

A etapa de classificação antecede a da eliminação do arquivo, isso porque um arquivo pode ser classificado como suspeito, malicioso ou falso positivo. A etapa de classificação de um arquivo consiste em analisar evidências técnicas como comportamento, assinaturas, hashes, origem e contexto, para determinar se o arquivo é malicioso, suspeito ou um falso positivo, ajudando na tomada de decisão correta sobre a resposta ou bloqueio da ameaça.

O YARA pode ser usado no processo de classificação de arquivos ao aplicar regras que identificam padrões específicos associados a malwares conhecidos ou comportamentos suspeitos; se um arquivo corresponder a uma ou mais regras YARA, ele pode ser classificado como malicioso ou suspeito, auxiliando na análise e reduzindo o risco de falsos positivos ao combinar critérios bem definidos.

Vamos usar a mesma regra usada na atividade 3.1.2 , mas agora vamos acrescentar os arquivos usados neste laboratório. Para isso siga os passos abaixo.

A regra YARA que será executada:

```
rule DetectarMalware {
meta:
descripition = "Detecta host usado para malware_download"
strings:
$host1 = "182.34.*.*"
$host2 = "117.220.*.*"
$host3 = "42.55.*.*"
$host4 = "154.81.*.*"
$threat = "malware_download"
$bitcoin = "mineracao"
$encrypter = "pyaes"
condition:
any of ($host*) or $bitcoin or $encrypter or $threat
}
```

Execute os seguintes passos para utilizar a regra Yara:

```
cd /tmp
```

```
vi detectar_malware
```
Copie e cole o exemplo de regra Yara apresentado acima no arquivo "detectar_malware.yar", depois digite :wq e pressione Enter para salvar e sair.

```
yara detectar_malware bitcoinMining.py
````
Ao executar o comando acima, você receberá uma mensagem de retorno "DetectarMalware" sinalizando que a regra detectou uma ou maais strings.

Pronto, agora temos uma regra para detectar arquivos que possam usar a biblioteca pyaes, ou que façam menção a mineração. Com isso, será mais fácil analisar arquivos suspeitos. 

## 4.3 Remoção Segura

Nos arquivos usados como exemplo foi possível verificar que eles estão sendo usados para executar ação maliciosa no sistema, por isso, o ideal é eliminá-los. Para fazer um eliminação segura dos arquivos execute os comandos abaixo: 

Antes de apagar, veja se o arquivo está em uso:
```
ss -tunlp
```
Caso ainda esteja em uso, finalize o processo usando o comando abaixo:
```
kill -9 PID
```

Remover o arquivo com segurança:
```
rm -f bitcoinMining.py
```


Verifique a persistência do malware:
A persistência do malware pode ser definida com técnicas utilizadas por uma ameaça para manter-se ativa no sistema infectado mesmo após reinicializações, logoffs ou tentativas de remoção, garantindo sua execução contínua. Para garantir que o arquivo foi de fato excluído execute os comandos abaixo: 

```
ps aux | grep bitcoinMining.py

ls -l /etc/init.d/

/etc/systemd/system/

cat /etc/rc.local

```



## Atividade 5 - Compartilhamento de IoCs

No contexto do monitoramento de segurança, o Zeek pode ser usado para fazer a análise do tráfego da rede em tempo real. Uma das principais funcionalidades dessa ferramenta é a detecção de ameaças. No projeto HackInSDN o Zeek desempenha um papel fundamental no processo de detecção de malware. Nesta atividade vamos usar o Zeek para detectar hashes de arquivos exportados do MISP.

### Atividade 5.1 - Captura do Tráfego

Para que o Zeek consiga efetuar a análise dos hashes, precisamos de um arquivo que contenha o tráfego da rede. Portanto, vamos executar o comando abaixo no terminal do Zeek para efetuar o processo de captura dos pacotes e armazená-lo em um arquivo chamado hash.pcap:

```
tcpdump -i zeek-eth1 -w hash.pcap
```
![f25](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f25.PNG?raw=true)


### Atividade 5.2 - Download dos hashes

Abra outra aba do terminal do Zeek, nele vamos executar um script desenvolvido com o propósito de exportar da base de inteligência de ameaças os hashes compartilhados na instância MISP na Atividade 4.2. Para isso execute os seguintes comandos no terminal do Mininet-Sec:

```
cd /tmp/
```
```
python3 export_hash.py -e <ID do evento> -t 'sha256' -f sha256.csv
```

Ao executar esse comando você gerou um arquivo com extensão CSV com todos os hash de arquivos contidos na evento criando no MISP. Execute o comando abaixo para visualizar o conteúdo do arquivo:

```
cat sha256.csv
````

A saída deve conter informações similares das que aparecem na imagem abaixo:

Agora volte ao outro terminal do mininet-sec e com CTRL+C para finalizar a execução da captura do tráfego da rede. 


### Atividade 5.3 - Executando o Zeek

No terminal do mininet-sec, Copie e cole o comando abaixo para efetuar o download do sript que será usado para detectar os hashes de arquivos extraídos do MISP.

```
cd /tmp
```
```
curl -LO https://raw.githubusercontent.com/Raquel-Santos/labs/refs/heads/main/lab03-analise-malware/scriptsZeek/detectar_hash.zeek
```
![f26](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f26.PNG?raw=true)

```
curl -LO https://raw.githubusercontent.com/Raquel-Santos/labs/refs/heads/main/lab03-analise-malware/scriptsZeek/local.zeek
```
![f27](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f27.PNG?raw=true)

Agora, no terminal do zeek execute o script por meio do seguintes comandos:

```
cd /tmp/
```
```
zeek -C -r hash.pcap detectar_hash.zeek
```
```
ls
```
Ao exexutar o script foram gerados alguns logs do Zeek, verifique os logs.  

