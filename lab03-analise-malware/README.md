# Roteiro do Laboratório de análise de Malware. 

 

![Topology](https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/images/topology.drawio.png) 

 

## Atividade 1: Teste de Conectividade 

 

Para verificar a conectividade, siga os passos abaixo: 

 

1. Verifique se a topologia foi carregada corretamente no Mininet-SEC. Esse passo é essencial para acessar os hosts que fazem parte do laboratório. 

 

   ![mininet_topologia](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet_topologia.png?raw=true) 

 

   ![topologia](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/lab_malware.PNG?raw=true) 

 

 

 

> [!IMPORTANT] 

> Você pode acessar o terminal dos hosts clicando duas vezes sobre eles ou pressionando o botão esquerdo do mouse e selecionando a opção "Terminal". 

 

 

2. Verifique se é possível acessar o terminal do Mininet-SEC. 

    ![mininet](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet.png?raw=true) 

 

4. Verifique se é possível acessar a interface do MSIP. 

    ![misp](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/misp.png?raw=true) 

 

## Atividade 2: Detecção de Malware: 

 

A técnica de engenharia social explora falhas humanas, visando persuadir a vítima a efetuar ações que facilitem o acesso indevido a sistemas restritos. Por meio da manipulação emocional, os atacantes transmitem mensagens geralmente com caráter de urgência com
a intenção de provocar emoções como, por exemplo, medo, empolgação, curiosidade, para assim convencê-la. Após conseguir a confiança da vítima, o atacante consegue efetuar o roubo de informações pessoais e dinheiro, realizar infecções por malware, ou qualquer
outra ação que pode gerar prejuízos ao usuário. O phishing, golpes de baiting, ataques de pretexto e ataques de DNS spoofing são apenas alguns exemplos de ataques que utilizam a engenharia social como base. 

 

![fraude](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/fraud16510.jpg?raw=true) 

*Fonte: Catálogo de Fraudes da RNP* 

 

Na imagem acima, é apresentado um exemplo de phishing bastante comum que tem sido transmitido via e-mail. A mensagem é referente a um falso mandado de intimação judicial, na vítima é persuadida a efetuar o download do documento para ter acesso a mais informações
a respeito do mandado, no entanto, ao clicar no link disponibilizado na mensagem um arquivo malicioso é baixado no sistema da vítima e caso executado poderá roubar informações do usuário. Este foi um caso real relatado no site no Catálogo de Fraudes da RNP,
o qual é um repositório de mensagens classificadas como fraudulentas, que pode ser utilizado como uma fonte de informação que auxilia a não propagação de fraudes disseminadas por e-mail e fornecendo informações sobre como se proteger desse tipo de golpe. 

 

> [!TIP] 

> Qual seria uma boa ação a se tomar ao receber um e-mail como o apresentado na acima? 

 

 

> [!TIP] 

> Um dos ataques que utilizam a técnica de engenharia social são ataques watering hole, explique como esse tipo de ataque ocorre: 

 

### Atividade 2.1 - Download de Arquivos Maliciosos 

 

Para este laboratório vamos simular uma infecção por malware ocasionada por um ataque de phishing similar ao que foi divulgado pelo Catálogo de Fraudes da RNP. Na mensagem fictícia abaixo, cujo assunto é Resgate de Brindes, o usuário é induzido a clicar em
um link para resgatar brindes de um suposto sorteio realizado por uma empresa de varejo. 

 

``` 

Olá, Cliente! 

 

Temos uma otima noticia para vc! Seu e-mail foi sorteado no nosso sorteio anual de fidelização. Todos os anos, a nossa empresa realiza essa ação para presentear clientes como vc, que fazem parte da nossa jornada com tanto carinho e confiança. 

 

É a nossa forma de agradecer pelo excelente relacionamento e por escolher nossa empresa! 

 

Clique no link abaixo para resgatar os brindes especiais que preparamos para vc: 

 

[Clique aqui para resgatar!] 

 

Atencaoo: O link ficará disponivel apenas pelas proximas 24h, a partir deste momento. Não perca! 

 

Atenciosamente, 

Equipe de Gestão de Relacionamento 

VarejoEmFoco Ltda 

 

Este é um e-mail automático. Por favor, não responda. 

``` 

 

Agora, imagine que essa mensagem chegou à sua caixa de entrada. A primeira ação que você deve tomar é verificar se o remetente realmente pertence à empresa mencionada. Com uma rápida pesquisa no Google, você conseguirá encontrar mais informações sobre a empresa. 

 

No caso da mensagem que estamos analisando, foi utilizada uma empresa fictícia, o que já nos levanta suspeitas sobre a veracidade das informações contidas no e-mail. Note que o atacante utiliza o fator da urgência para tentar pressionar o usuário a clicar no
link rapidamente, com a promessa de uma recompensa falsa. 

Um usuário atento se perguntaria se, de fato, está lidando com uma empresa com a qual tem relacionamento. A mensagem afirma que você foi incluído no sorteio devido à sua fidelidade com a empresa, o que indica que não deveria se tratar de uma empresa desconhecida
para você. 

Caso ainda tenha dúvidas sobre a autenticidade da mensagem, uma boa prática é, antes de clicar no link, compartilhar a URL em serviços de identificação de URLs maliciosas, como o CaUMa e o VirusTotal, por exemplo. Esses serviços mantêm uma base de dados de
URLs maliciosas, coletadas pelo sistema ou reportadas por usuários, com o objetivo de identificar links suspeitos ou perigosos. 

 

Vamos supor que você é um usuário desatento e não seguiu as recomendações feitas anteriormente e clicou no link contido na mensagem. Após clicar, um arquivo será instalado na sua máquina. Este arquivo se trata de um ransomware. O primeiro passo é fazer o download
dos scripts e arquivos necessários para simular o ataque. Disponibilizamos um arquivo que será criptografado e scripts para efetuar a criptografia e descriptografia desse arquivo: 

 

Acesse o terminal do Mininet-Sec a partir do Dashboard HackInSDN para efetuar o download dos arquivos: 

![mininet](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet.png?raw=true) 

 

Em seguida, no terminal do Mininet-Sec, execute os seguintes comandos: 

 

``` 

cd /tmp 

 

``` 

``` 

curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/ransomware/encrypter.py 

``` 

![f1](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f1.PNG?raw=true) 

``` 

curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/ransomware/decrypter.py 

``` 

 

![f2](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f2.PNG?raw=true) 

``` 

curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/ransomware/hackinsdn.txt 

``` 

![f3](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f3.PNG?raw=true) 

 

## Atividade 3 - Análise de Malware 

 

### Atividade 3.1 - Análise Estática 

 

No processo da análise estática examinamos o malware sem executá-lo com o intuito de identificar informações no código que possam sinalizar possíveis ações maliciosas contidas no programa. Algumas ferramentas comuns de uso nesse processo de análise de binários
são: IDA Pro, Ghidra e Radare2, por exemplo. 

 

Para este laboratório vamos usar duas ferramentas para exemplificar o processo de análise estática de malware. entender. CAUMA e YARA são ferramentas que nos ajudam a classificar e detectar malwares. 

 

**3.1.1 - Análise Comportamento Malicioso** 

No terminal do Mininet-Sec execute o seguinte comando para conseguir visualizar o código: 

``` 

cat /tmp/encrypter.py 

``` 

 

Analise o código abaixo para identificar possíveis ações maliciosos: 


![f4](https://github.com/hackinsdnlabs/blob/main/lab03-analise-malware/images/f4.PNG?raw=true) 

 

Observe que esse código utiliza a biblioteca pyaes, a qual implementa o algoritmo AES (Advanced Encryption Standard) muito usado no processo de criptografia simétrica. É possível verificar também que na linha é criando um objeto AES que recebe a chave e em
seguida é utilizada a função encrypt() para fazer a criptografia de um arquivo de texto presente na máquina do usuário (hackinsdn.txt). Em um ataque real, o cibercriminoso usaria essa função para criptografar todos os arquivos que considera relevantes para
a vítima. Para isso, ele colocaria essa linha de código dentro de um laço de repetição (loop), permitindo a exploração dos diretórios da máquina comprometida. 

 

 

> [!TIP] 

> Qual é o principal objetivo de um ataque de phishing? 

 

 

**Atividade 3.1.2 - Detecção e Classificação de Arquivos Maliciosos com o YARA** 

 

Primeiro vamos coletar algumas informações de URLs maliciosas por meio do Feed do CAUMA, para isso, acesse o link abaixo: 

 
```
https://cauma.pop-ba.rnp.br/feed_doc.html
``` 
![f53](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f53.PNG?raw=true)

Agora clique em https://cauma.pop-ba.rnp.br/feed/txt e em seguida copie algumas URLs que são apresentadas na página, cole essas URLs no arquivo cauma.txt. Para isso, no terminal do MISP, execute os comandos abaixo: 
 

``` 
cd > cauma.txt 

``` 

Após colar pressione as teclas Ctrl+D para sair do modo edição. 
 

> [!NOTE] 

> Depois de coletar URLs maliciosas do CAUMA você pode gerar o hash desse arquivo. Com esse hash você pode enviar para o VirusTotal, o qual irá verificar se o arquivo é identificado como malicioso por diversos antivírus e outras ferramentas de segurança. Assim,
você consegue validar rapidamente se o arquivo é uma ameaça real. 

 

Podemos usar o YARA para criar uma regra de detecção para as URLs contidas nesse arquivo. Abaixo é possível verificar como construir essa regra: 

``` 

rule DetectarMalware { 

meta: 

descripition = "Detecta host usado para malware_download" 

strings: 

$host1 = "<url1>" 

$host2 = "<url2>" 

$host3 = "<url3>" 

$host4 = "<url4>" 

$threat = "malware_download" 

condition: 

any of ($host*) or $threat 

} 

``` 

Substitua as strings $host* pelas URLs encontradas no CAUMA, por exemplo: $host1 = “<url.encontrada.no.cauma>”, 

 

Para executar a regra YARA você pode usar os comandos abaixo: 

``` 

cat > regra.yar 

``` 

Copie e cole o exemplo de regra Yara apresentado acima no arquivo "regra.yar", depois pressione Ctrl+D para salvar e sair. E em seguida use o comando abaixo: 

``` 
yara regra.yar cauma.txt 
```` 

 

Ao executarmos essa regra será possível detectar sempre que alguma URL listada for detectada uma ameaça de malware na lista de URLs coletadas do CAUMA. Com o YARA é possível, por exemplo, criar regras para detectar se um binário pertence a uma família conhecida,
escanear vários arquivos em busca de encontrar ameaças com base em regras definidas, fazer a detecção de malware em tempo real por meio da sua integração com antivírus, SIEMs ou sistemas de monitoramento etc. 

 

> [!NOTE] 

> O YARA, uma ferramenta de código aberto desenvolvida pela VirusTotal e permite que você utilize o VirusTotal Intelligence (VT Enterprise) para enviar suas regras YARA, que são aplicadas à extensa base de dados de arquivos do VirusTotal, notificando-o automaticamente
sempre que novos arquivos corresponderem a essas regras. 

 

**Atividade 3.1.3 - Correlacionamento de Ameaças** 

 

O correlacionamento de ameaças é um processo no qual é possível conectar e analisar diferentes indicadores de compromisso (IoCs), comportamentos e padrões de ataque para identificar, entender e responder a ameaças cibernéticas de forma mais eficaz. O MISP é
uma plataforma amplamente utilizada para o compartilhamento, a ferramenta possui uma API REST que viabiliza a importação e exportação de IoCs de forma automatizada. 

 

Para acessar a API do MISP, vamos usar a biblioteca PyMISP. Para isso, vamos usar dois scripts, um para a importação e outro para exportação de IoCs. Vamos iniciar com o script de importação, no terminal do MISP, execute os passos abaixo: 

 
```
cd /tmp 
``` 

```
cd > import.py 
``` 

Agora copie e cole o código abaixo no arquivo import.py.

```
#!/usr/bin/env python
# -*- coding: utf-8 -*-

from pymisp import PyMISP
from keys import misp_url, misp_key, misp_verifycert
import argparse

from io import open


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Update a MISP event.")
    parser.add_argument("-e", "--event", required=True, help="Event ID to update.")
    parser.add_argument("-i", "--input", required=True, help="Input file")

    args = parser.parse_args()

    pymisp = PyMISP(misp_url, misp_key, misp_verifycert)

    with open(args.input, 'r') as f:
        result = pymisp.freetext(args.event, f.read())
    print(result)
```

Agora vamos acessar a interface do MISP para selecionar o serviço do MISP. Ao clicar, você irá visualizar um alerta, basta clicar em "Avançadas" e em seguida em "Ir para site não seguro". 

 

![misp](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/misp.png?raw=true) 

 

 

![f28](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f28.PNG?raw=true) 

 

Aguarde alguns segundo o carregamento do serviço: 

 

![f41](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f41.PNG?raw=true) 

 

Para fazer o login forneça as seguintes credenciais de acesso: 

``` 

E-mail: admin@localhost 

``` 

``` 

Senha: hackinsdn 

``` 

 

![f30](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f30.PNG?raw=true) 

 

Na aba de menu do MISP clique na opção “Home” e em seguida em “List Events” como mostra as imagens abaixo: 

 

![f31](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f31.PNG?raw=true) 

 

 

Note que a lista de eventos está vazia, isso acontece porque não estamos usando uma instância de produção, a instância foi elaborada para os laboratórios do da plataforma HackInSDN e simula uma instância recém-instalada, logo, por padrão, ao instalar o MISP
ele não inicia com eventos pré-carregados. Dessa forma, será necessário criar novos eventos, efetuar a sincronização com outras instâncias e/ou habilitar as fontes automáticas de dados de inteligência de ameaça (feeds) disponíveis no MISP, inicialmente, vamos
seguir com a última opção: habilitar os feeds públicos. 

 

Para habilitar os feeds públicos você deve clicar em “Sync Actions” >> “Feeds”, serão listados os dois feeds públicos disponíveis no MISP: CIRCL OSINT Feed e The Botvrij eu Data. Para habilitar o feed selecione ele e clique em “Enable Selected” e em seguida
em "Yes". As imagens abaixo ilustram o passo a passo que você deverá executar: 

 

![f36](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f36.PNG?raw=true) 

 

![f37](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f37.PNG?raw=true) 

 

![f38](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f38.PNG?raw=true) 

 

![f39](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f39.PNG?raw=true) 

 

![f40](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f40.PNG?raw=true) 

 

 

> [!IMPORTANT] 

> O processo de carregamento dos eventos poderá demorar algumas horas, ou até mesmo dias, mas para visualizar os novos eventos clique em “Event Actions > List Events” e deverá aparecer a lista de envios importados na instância. 

 

Agora vamos criar um novo usuário na organização HackInSDN, esse usuário será usado para acessar a API do MISP. Para isso, execute os passos abaixo. 

 

Clique em “Administration > List users > Add user. E em seguida, preencha os campos com as informações do novo usuário, como no exemplo abaixo: 

![f42](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f42.PNG?raw=true)

![f43](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f43.PNG?raw=true)

![f44](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f44.PNG?raw=true)

Faça o logoff da conta admin e, em seguida, faça o login com o novo usuário criado. Será solicitado que você altere a senha:
![f45](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f45.PNG?raw=true)

![f46](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f46.PNG?raw=true)



Agora você irá criar uma chave de acesso a API, essa chave só será exibida uma única vez, por isso, você precisará copiar e armazenar ela. Essa chave será necessária nas próximas atividades, as imagens abaixo exemplificam o passo a passo: 

![f47](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f47.PNG?raw=true)


![f48](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f48.PNG?raw=true)


![f49](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f49.PNG?raw=true)


![f50](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f50.PNG?raw=true)


![f51](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f51.PNG?raw=true)


![f52](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f52.PNG?raw=true)

Agora com que temos um novo usuário e que foi atribuída a chave da API a ele, vamos para os próximos passos. 

Você deverá criar um arquivo chamado keys.py, ele será importado nos scripts para passar as informações de acesso a API do MISP, copie e cole o conteúdo do código abaixo no mesmo diretório dos scripts usados para importação e exportação de dados no MISP, lembre de substituir o misp_key pela chave gerada na questão anterior:

```
#!/usr/bin/env python
# -*- coding: utf-8 -*-

misp_url = 'https://200.133.0.61:31183'
misp_key = '<>' 
misp_verifycert = False
#misp_client_cert = ''
#proofpoint_sp = '<proofpoint service principal>' 
#proofpoint_secret = '<proofpoint secret>' 
```

![f60](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f60.PNG?raw=true)
 
Vamos criar um novo evento no MISP, para isso clique em "Add Event", preencha as informações do evento e em seguida clique em "Submit". Você conseguirá visualizar o evento criado na lista de eventos. Anote o ID do evento criado para teste, pois ele será usado
nas etapas seguintes. As imagens abaixo ilustram o passo a passo que você deverá executar: 

 

![f32](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f32.PNG?raw=true) 

 

![f33](https://github.com/user-attachments/assets/d1120ef3-8188-4322-b19f-2df11bb9f488) 

 

![f34](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f34.PNG?raw=true) 

 

![f35](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f35.PNG?raw=true) 

  

> [!IMPORTANT] 

> Note que é gerado um aviso em o evento ter sido criado sem objetos/atributos, portanto o próximo passo será preencher esse evento com as URLs coletadas do CAUMA. 

 

Agora, no terminal do MISP, execute o script de importação a partir dos eguintes comandos: 

 

``` 

cd /tmp 

``` 

``` 

phyton3 import.py -e <ID do evento criado> -i cauma.txt 

``` 

![f54](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f54.PNG?raw=true)


O evento criado deverá aparecer no topo da lista de eventos, na interface do MISP clique novamente em “Event Actions > List Events” e procure o evento que foi criado.  A lista está configurada para exibir os eventos mais recentes no início, logo, no topo da lista você deverá visualizar o evento que acabou de criar, clicando no evento você terá acesso às informações do evento. 

 
![f55](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f55.PNG?raw=true)



![f56](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f56.PNG?raw=true) 

Para exportar as urls você pode executar os seguintes passos:

```
cat /tmp

```

```
cat > export.py
```
```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse

from pymisp import ExpandedPyMISP
from keys import misp_url, misp_key, misp_verifycert


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Get MISP stuff as CSV.')
    parser.add_argument("--controller", default='attributes', help="Attribute to use for the search (events, objects, attributes)")
    parser.add_argument("-e", "--event_id", help="Event ID to fetch. Without it, it will fetch the whole database.")
    parser.add_argument("-a", "--attribute", nargs='+', help="Attribute column names")
    parser.add_argument("-o", "--object_attribute", nargs='+', help="Object attribute column names")
    parser.add_argument("-t", "--misp_types", nargs='+', help="MISP types to fetch (ip-src, hostname, ...)")
    parser.add_argument("-c", "--context", action='store_true', help="Add event level context (tags...)")
    parser.add_argument("-f", "--outfile", help="Output file to write the CSV.")

    args = parser.parse_args()
    pymisp = ExpandedPyMISP(misp_url, misp_key, misp_verifycert, debug=True)
    attr = []
    if args.attribute:
        attr += args.attribute
    if args.object_attribute:
        attr += args.object_attribute
    if not attr:
        attr = None
    print(args.context)
    response = pymisp.search(return_format='csv', controller=args.controller, eventid=args.event_id, requested_attributes=attr,
                             type_attribute=args.misp_types, include_context=args.context)

    if args.outfile:
        with open(args.outfile, 'w') as f:
            f.write(response)
    else:
        print(response)
print("\nDados Exportados com sucesso! ")
```
Copie e cole o código no arquivo export.py e, em seguida, pressione as teclas Ctrl+D para salvar e sair. 

Execute o comando abaixo:

```
phyton3 export.py -e <ID do evento criado> -f teste.csv 

```
![f57](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f57.PNG?raw=true)


![f58](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f58.PNG?raw=true)


Para executar a regra do Yara execute o seguinte comando:

![f59](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f59.PNG?raw=true)


> [!IMPORTANT] 

> As URLs apresentadas como exemplo desse laboratório foram exportadas do feed do CAUMA, sendo que o mesmo  é atualizada a cada 5min, ou seja, algumas dessas URLs podem não está online no momento de execução deste laboratório.  


### 3.2 - Análise Dinâmica 

Na análise dinâmica é feita a execução do malware em um ambiente isolado, como o Mininet-Sec por exemplo, para ser possível verificar o seu comportamento em tempo real. Com isso, é possível realizar o monitoramento do sistema e da rede. 

 

**3.2.1 - Simulação de Ataque Ransomware** 

 

Notícias como esta revelam que os ataques de ransomware estão crescendo e representam uma grande ameaça à segurança digital. Esse ataque consiste na execução de um malware que criptografa arquivos externos e bloqueia o acesso do usuário dono dos arquivos. Em
seguida, o cibercriminoso solicita que a vítima transfira um valor para o resgate dos dados; geralmente, esse valor é pago em criptomoedas. Apesar de grandes empresas serem os alvos mais recorrentes desse tipo de ataque, usuários comuns também estão sujeitos
a essa ameaça. 

 

Utilizando o código anterior como exemplo, portanto, vamos executar o código encrypter.py para verificar na prática o comportamento de um ataque de ransomware, vamos imaginar que você é um usuário desatento e clicou no e-mail “Resgate de Brindes” apresentado
no tópico 2.1. O download dos arquivos foi realizado na secção anterior, o próximo passo é executar o arquivo no host outside1: 

 

O Mininet-Sec é um emulador de redes responsável pela criação da topologia apresentada na Imagem 1. Clique no link do Serviço "http-mininet-sec" conforme ilustrado abaixo para abrir a interface web do Mininet-Sec: 

 

![f8](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/mininet_topologia.png?raw=true) 

 

 

Neste exemplo, vamos simular um ataque de ransomware, execute o seguinte comando no Terminal do Mininet-Sec: 

 

``` 

pip install pyaes 

``` 

Essa biblioteca, a qual está sendo utilizada nos scripts encrypter.py e decrypter.py para criptografar e descriptografar os dados usando o algoritmo AES (Advanced Encryption Standard), que é um dos padrões mais utilizados de criptografia simétrica. 

 

![f8](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f8.PNG?raw=true) 

 

Agora, no terminal do outsider1 execute o seguinte comando: 

 

``` 

python3 /tmp/encrypter.py 

``` 

 

![f9](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f9.PNG?raw=true) 

 

Veja que ao executar o comando fez com que o arquivo hackinsdn.txt fosse criptografado, substituindo-o por hackinsdn.txt.ransomware. Esse script acabou de simular o que acontece quando o usuário executar um ransomware em sua máquina. Agora execute o comando
abaixo para verificar o que aconteceu com o arquivo. 

 

``` 

cat /tmp/hackinsdn.txt.ransomware 

 

``` 

![f10](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f10.PNG?raw=true) 

 

É possível notar que o arquivo hackinsdn.txt.ransomware contém caracteres incompreensíveis, pois o conteúdo foi criptografado utilizando criptografia simétrica. Para restaurar a legibilidade do arquivo, será necessário descriptografá-lo com o código decrypter.py.
Em um ataque real, esse processo de descriptografia só poderia ser realizado pelo cibercriminoso, que exigiria um pagamento de resgate para liberar os dados para a vítima. Mas infelizmente, mesmo que efetuando o pagamento de resgate a vítima não tem garantia
de que o cibercriminoso irá devolver o arquivo original. Para ter uma ideia de como funciona esse processo de descriptografia, ainda no terminal do outsider1, execute os comandos abaixo: 

 

``` 

cat /tmp/ecrypter.py 

``` 

![f23](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f23.PNG?raw=true) 

``` 

python3 /tmp/decrypter.py 

``` 

 

``` 

ls 

``` 

 

``` 

cat /tmp/hackinsdn.txt 

``` 

Como dito anteriormente, ao final o arquivo voltará ao seu formato original, conforme ilustrado na figura abaixo: 

 

![f12](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f12.PNG?raw=true) 

 

 

> [!TIP] 

> O que caracteriza um ataque de ransomware? 

 

 

> [!TIP] 

> Cite uma medida eficaz para prevenir ataques de ransomware: 

 

 

**3.2.2 - Simulação de Cryptojacking** 

 

Seguindo na análise dinâmica vamos simular um ataque de criptografia maliciosa e em seguida vamos efetuar o monitoramento do sistema para verificar os impactos gerados. 

 

A criptografia maliciosa é um ataque que ocorre na execução não autorizada de um binário em um computador ou dispositivo móvel, com o intuito de utilizar seus recursos para minerar criptomoedas. O processo de mineração de criptomoedas requer bastante energia
e recursos computacionais. Os cibercriminosos efetuaram esse tipo de ataque para não pagar por esses recursos, ou seja, para extrair a criptomoeda sem as grandes despesas. 

 

Similar ao que fizemos na simulação do ataque de ransomware, vamos supor que, ao efetuar o download dos arquivos disponibilizados no link do e-mail “Resgate de Brindes”, você instalou um executável com o intuito de realizar a mineração de bitcoin.Vamos executar
no h101 o arquivo bitcoinMining.py. 

 

Acesse o terminal do h101 a partir do Dashboard HackInSDN para fazer o monitoramento do sistema, pois assim será possível comparar o estado anterior e posterior da execução do bitcoinMining.py. E, em seguida, no terminal do host h1, execute os seguintes comandos: 

 

``` 

top 

``` 

![f13](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f13.PNG?raw=true) 

 

Observe que a CPU apresenta um consumo dentro dos limites esperados. 

 

Acesse o terminal do Mininet-Sec a partir do Dashboard HackInSDN para efetuar o download do arquivo: 

 

![mininet](https://github.com/hackinsdnlabs/blob/main/lab03-analise-malware/images/mininet.png?raw=true) 

 

Em seguida, no terminal do Mininet-Sec, execute os seguintes comandos: 

 

``` 

cd /tmp 

``` 

``` 

curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab_analyze_malware/maliciousEncryption/bitcoinMining.py 

``` 

``` 

python /tmp/bitcoinMining.py 

``` 

![f14](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f14.PNG?raw=true) 

 

![f15](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f15.PNG?raw=true) 

 

 

> [!TIP] 

> O que é cryptojacking? 

 

### Atividade 3.3 - Monitoramento do Sistema 

 

Na seção tópico anterior, simulamos um ataque de criptografia maliciosa. Agora, vamos utilizar as ferramentas de monitoramento da atividade anterior para analisar os impactos gerados pelo script bitcoinMining.py, ou seja, vamos comparar o estado do sistema
antes e depois da execução do script. 

 

 

Acesse o terminal do host1 a partir do Dashboard HackInSDN para verificar se ocorrem alterações no consumo da CPU e do disco, para isso, execute os seguintes comandos: 

 

``` 

top 

 

``` 

![f17](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f17.PNG?raw=true) 

 

Este comando permite que você exiba em tempo real o consumo de CPU, memória, e outros recursos do sistema. Observe que agora existe um processo que utiliza o comando python3 consumindo 100% da CPU, esse comportamento simula como um ataque de cryptojacking pode
fazer uso não autorizado de recursos computacionais de um sistema para minerar criptomoedas. Geralmente, o processo roda em segundo plano, sem o consentimento do usuário, causando danos como: redução drasticamente o desempenho de outras aplicações críticas,
aumento do consumo de energia e aquecimento excessivo, além de 

danificar hardware em situações extremas e contínuas. 

 

``` 

dstat -c --cpu-adv 

 

``` 

![f18.1](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f18.1.PNG?raw=true) 

 

Este comando permite que você veja estatísticas detalhadas da CPU em tempo real, com o parâmetro -c você terá acesso estatísticas básicas de CPU e com o --cpu-adv você receberá informações avançadas da CPU. 

 

Note que o top mostrou 100% de consumo da CPU, enquanto o dstat apresentou um uso moderado. Isso acontece porque, o top exibe o uso por processo individual, mostrando quanto de um núcleo aquele processo está consumindo. Já o dstat, mostra o uso agregado da
CPU como um todo, somando o uso entre todos esses núcleos. Essa divergência entre top e dstat é, portanto, esperada, visto que estamos apenas simulando um ataque. Em contextos reais de segurança, correlacionar múltiplas fontes de monitoramento (como top, dstat,
mpstat, e logs de processos) é essencial para detectar comportamentos maliciosos disfarçados de processos legítimos. Dessa forma, podemos concluir que a mineração ilegal é caracterizada por um uso contínuo de 100% da CPU em um ou mais núcleos, apesar de a
utilização total do sistema parecer "inferior". Esse padrão é um forte indicador de cryptojacking ou exploração de recursos sem autorização. 

 

 

> [!TIP] 

> Qual sintoma no sistema pode indicar a presença de cryptojacking e como ele, geralmente, se propaga? 

 

## Atividade 4 - Processo de Mitigação 

O processo de mitigação envolve a implementação de ações e controles para reduzir ou neutralizar os impactos de uma ameaça cibernética identificada, minimizando os danos potenciais e evitando que a vulnerabilidade seja explorada novamente no futuro. 

 

Neste laboratório vamos demonstrar algumas das principais etapas do processo de remediação de malware. Vamos simular o isolamento do arquivo, a verificação de hases, classificação do arquivo e, caso seja classificado como malicioso, a sua remoção segura. 

 

## 4.1 Coletar o hash do arquivo 

 

A coleta do hash de um arquivo é fundamental para identificar, verificar a integridade e cruzar informações sobre o arquivo em bancos de dados de ameaças, como o VirusTotal, sem a necessidade de executá-lo. 

 

Para coletar o hash dos arquivos baixados nesse laboratório execute os comandos abaixo, no terminal do Mininet-Sec: 

 

``` 

mkdir /tmp/zeek 

``` 

``` 

cd /tmp/zeek 

``` 

``` 

md5sum bitcoinMining.py >> md5.txt 

sha256sum bitcoinMining.py >> sha256.txt 

``` 

 

![f20](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f20.PNG?raw=true) 

 

![f20](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f21.PNG?raw=true) 

 

 

Agora vamos importar esses hashes para o evento que criamos anteriomente no MISP, para isso execute os passos abaixo no terminal do MISP: 

 

``` 

cd /tmp/zeek 

``` 

 

``` 

cd > sha256.txt 

``` 

Copie e cole o hash gerado nesse arquivo e pressione Ctrl+D para salvar e sair. 

 

Agora no terminal do MISP execute o script: 

 
```
python3 import.py -e <ID do evento criando anteriormente> -i sha256.txt 

``` 

 

> [!NOTE] 

> Estamos usando o MD5 e SHA256, porque, apesar do MD5 não ser tão seguro ele é melhor para comparar com bancos de malware como o VirusTotal, já o SHA256 é mais seguro e por isso foi usado para garantir a integridade do arquivo: 

 

## 4.2 Classificando com regra YARA 

 

A etapa de classificação antecede a da eliminação do arquivo, isso porque um arquivo pode ser classificado como suspeito, malicioso ou falso positivo. A etapa de classificação de um arquivo consiste em analisar evidências técnicas como comportamento, assinaturas, hashes, origem e contexto, para determinar se o arquivo é malicioso, suspeito ou um falso positivo, ajudando na tomada de decisão correta sobre a resposta ou bloqueio da ameaça. 

 

O YARA pode ser usado no processo de classificação de arquivos ao aplicar regras que identificam padrões específicos associados a malwares conhecidos ou comportamentos suspeitos; se um arquivo corresponder a uma ou mais regras YARA, ele pode ser classificado como malicioso ou suspeito, auxiliando na análise e reduzindo o risco de falsos positivos ao combinar critérios bem definidos. 

 

Vamos usar a mesma regra usada na atividade 3.1.2 , mas agora vamos acrescentar outros arquivos usados neste laboratório. Para isso siga os passos abaixo. 

 

A regra YARA que será executada: 

 

``` 

rule DetectarMalware { 

meta: 

descripition = "Detecta host usado para malware_download" 

strings: 

$host1 = "<hash1>" 

$host2 = " <hash2>" 

$threat = "malware_download" 

$bitcoin = "mineracao" 

$encrypter = "pyaes" 

condition: 

any of ($host*) or $bitcoin or $encrypter or $threat 

} 

``` 

 

Substitua os campos <$host = “<hash>”, pelos hashes  gerados na atividade 4.1. E no terminal do MISP. execute os seguintes passos para utilizar a regra Yara: 

 

``` 

cd /tmp 

``` 

 

``` 

cat > regra2.yar 

``` 

Copie e cole o exemplo de regra Yara apresentado acima no arquivo "regra2.yar", depois pressione Ctrl+D para salvar e sair. 

Agora, siga os mesmos passos para copiar o conteudo do arquivo bitcoinMining.py.

bitcoinMining.py:

```
from hashlib import sha256
import time

def function_sha256(text):
	return sha256(text.encode("ascii")).hexdigest()

def mining(block, transctions, hash_before, amount_zeros):
	nonce = 0
	while True:
		text = str(block) + transctions + hash_before + str(nonce)
		my_hash = function_sha256(text)
		if  my_hash.startswith("0" * amount_zeros):
			return nonce, my_hash
		nonce += 1
block = 15
transctions = """
Raquel->Maria->10
Mayara->Joao->20
Talita->Alice->15"""

amount_zeros = 10
hash_before = "abc"
start = time.time()
result = mining(block, transctions, hash_before, amount_zeros)
print(result)
print(time.time() - start)
```

``` 

cd /tmp 

``` 

``` 
cat >  bitcoinMining.py 
``` 
Copie e cole o codigo acima no arquivo "bitcoinMining.py ", depois pressione Ctrl+D para salvar e sair. 


Agora, no mesmo diretório , execute a regra:


``` 
yara regra2.yar bitcoinMining.py 
```` 

Ao executar o comando acima, você receberá uma mensagem de retorno "DetectarMalware" sinalizando que a regra detectou uma ou mais strings. 

 

Pronto, agora temos uma regra para detectar arquivos que possam usar a biblioteca pyaes, ou que façam menção a mineração. Com isso, será mais fácil analisar arquivos suspeitos. 

 

## 4.3 Remoção Segura 

 

Nos arquivos usados como exemplo foi possível verificar que eles estão sendo usados para executar ação maliciosa no sistema, por isso, o ideal é eliminá-los. Para fazer uma eliminação segura dos arquivos execute os comandos abaixo: 

 

Antes de apagar, veja se o arquivo está em uso: 

``` 

ss -tunlp 

``` 

Caso ainda esteja em uso, finalize o processo usando o comando abaixo: 

``` 

kill -9 <PID> 

``` 

 

Remover o arquivo com segurança: 

``` 

rm -f bitcoinMining.py 

``` 

 

 

Verifique a persistência do malware: 

A persistência do malware pode ser definida com técnicas utilizadas por uma ameaça para manter-se ativa no sistema infectado mesmo após reinicializações, logoffs ou tentativas de remoção, garantindo sua execução contínua. Para garantir que o arquivo foi de
fato excluído execute os comandos abaixo: 

 

``` 
ps aux | grep bitcoinMining.py 
```
 
```
ls -l /etc/init.d/ 

````

 

## Atividade 5 - Zeek e MISP no monitoramento de segurança

No contexto do monitoramento de segurança, o Zeek pode ser usado para fazer a análise do tráfego da rede em tempo real. Uma das principais funcionalidades dessa ferramenta é a detecção de ameaças. No projeto HackInSDN o Zeek desempenha um papel fundamental no processo de detecção de malware. Nesta atividade vamos usar o Zeek para detectar hashes de arquivos exportados do MISP. Essa atividade tem o objetivo de fazer com que você consiga identificar os passos que podem ser usados no processo de monitoramento de segurança com o Zeek a partir de IoCs coletados do MISP. Os passos a seguir não foram elaborados para serem executados, apenas  passos para servir de referência para estudos a respeito do processo de monitoramento com o Zeek. 

### Captura do Tráfego

Para que o Zeek consiga efetuar a análise dos hashes, precisamos de um arquivo que contenha o tráfego da rede. Portanto, o comando abaixo pode ser executado para efetuar o processo de captura dos pacotes e armazená-lo em um arquivo chamado hash.pcap:

```
tcpdump -i zeek-eth1 -w hash.pcap
```
![f25](https://github.com/hackinsdn/labs/blob/main/lab03-analise-malware/images/f25.PNG?raw=true)


### Download dos hashes

Hashes de arquivos, como os gerados nas atividades anteriores, podem ser importados no MISP por meio de um script, como o que foi apresentado como exemplo também nas atividades anteriores (import.py). No processo de exportação também é possível utilizar scripts, a exemplo do export.py também usado nesse laboratório. Para exportar os hashes do tipo sha256, por exemplo, de uma instância MISP o comando abaixo poderá ser utilizado:

```
python3 export.py -e <ID do evento> -t 'sha256' -f sha256.csv
```

![f63](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f63.PNG?raw=true)

![f61](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f61.PNG?raw=true)

![f62](https://github.com/Raquel-Santos/labs/blob/main/lab03-analise-malware/images/f62.PNG?raw=true)

Ao executar esse comando você poderá gerar um arquivo com extensão CSV com todos os hash de arquivos contidos no evento criando no MISP. A saída deve conter informações similares das que aparecem na imagem abaixo:

Após executar o download do arquivo no terminal em que você rodou o comando tcpdump, usando o CTRL+C, deve ser finalizada a execução da captura do tráfego da rede.


### Executando o Zeek
O Zeek pode ser executado por meio de um script para detectar os hashes exportados do MISP, um exemplo de comando é apresentado abaixo::


```
zeek -C -r hash.pcap detectar_hash.zeek
```

Após executar o script são gerados alguns logs do Zeek, os logs podem ser executados para verificar as informações que foram capturadas no tráfego. 

No Mininet-Sec execute o download e visualize exemplos de arquivos necessários no processo de detecção de hashes com o Zeek, esses arquivos precisam ser inseridos no mesmo diretório:

```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/scriptsZeek/detectar_hash.zeek
```
```
curl -LO https://raw.githubusercontent.com/hackinsdn/labs/refs/heads/main/lab03-analise-malware/scriptsZeek/local.zeek
```




